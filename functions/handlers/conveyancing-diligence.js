const { onRequest } = require("firebase-functions/v2/https");
const { OpenAI } = require("openai");

/**
 * Generate AI-powered Report on Title
 * This function integrates with OpenAI to provide comprehensive title analysis
 */
const generateDiligenceReport = onRequest(
  {
    cors: true,
    invoker: "public", // Demo access - would be "private" in production
  },
  async (req, res) => {
    try {
      // Only allow POST requests
      if (req.method !== "POST") {
        return res.status(405).json({ error: "Method not allowed" });
      }

      const { stateData, claimsData, analysisType = "report-on-title" } = req.body;

      if (!stateData) {
        return res.status(400).json({ error: "State data is required" });
      }

      // Generate AI-powered Report on Title
      const reportOnTitle = await generateReportOnTitle(stateData, claimsData);

      const report = {
        analysisType,
        timestamp: new Date().toISOString(),
        transactionId: stateData.transactionId || "unknown",
        property: {
          address: stateData.propertyPack?.address || "Address not specified",
          titleNumber: stateData.propertyPack?.titleNumber || "Title number not available",
        },

        // AI Generated Report on Title
        reportOnTitle: reportOnTitle || "AI Report on Title unavailable - please check OpenAI configuration",

        // Disclaimer
        disclaimer: "This Report on Title is generated by AI for demonstration purposes. This analysis should not be relied upon for actual conveyancing transactions. Professional legal advice should always be sought.",
      };

      res.json({
        success: true,
        report,
      });
    } catch (error) {
      console.error("Error generating Report on Title:", error);
      res.status(500).json({
        error: "Failed to generate Report on Title",
        details: error.message,
      });
    }
  },
);

// OpenAI Integration for Report on Title
async function generateReportOnTitle(stateData, claimsData) {
  try {
    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });

    if (!process.env.OPENAI_API_KEY) {
      console.log("OpenAI API key not found, skipping AI Report on Title generation");
      return null;
    }

    // Create comprehensive prompt for Report on Title
    const prompt = createReportOnTitlePrompt(stateData, claimsData);

    const response = await openai.chat.completions.create({
      model: "gpt-4.1", // Use GPT-4.1 which has a 1 million token context window
      messages: [
        {
          role: "system",
          content: "You are an experienced conveyancing solicitor preparing a comprehensive Report on Title. Your response should be a detailed, professional report examining the title to the property, identifying any issues, risks, or concerns that could affect the transaction.",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      temperature: 0.3, // Lower temperature for more consistent, professional analysis
      // Remove max_tokens limit to allow full-length reports
    });

    const aiContent = response.choices[0]?.message?.content;
    if (!aiContent) return null;

    // Try to parse structured response or return as text
    try {
      return JSON.parse(aiContent);
    } catch (e) {
      // Return the full report as text
      return aiContent;
    }
  } catch (error) {
    console.error("Error generating Report on Title:", error);
    return null;
  }
}

function createReportOnTitlePrompt(stateData, claimsData) {
  return `
REPORT ON TITLE REQUEST

Please prepare a comprehensive Report on Title for the following property transaction. This should be a formal legal document suitable for a conveyancing client.

COMPLETE PROPERTY TRANSACTION STATE:
${JSON.stringify(stateData, null, 2)}

Please prepare a formal Report on Title structured as follows:

REPORT ON TITLE

PROPERTY: [Address]
TITLE NUMBER: [Title Number]
DATE: [Current Date]

1. TITLE SUMMARY
- Brief description of the property and title
- Registered proprietor details
- Class of title and tenure

2. TITLE EXAMINATION
- Review of title documents and entries
- Analysis of any restrictions on the register
- Examination of charges and incumbrances
- Review of covenants affecting the property

3. PLANNING AND STATUTORY MATTERS
- Planning permissions and applications
- Building regulations compliance
- Conservation area or listed building status
- Environmental and contamination issues

4. THIRD PARTY RIGHTS
- Rights of way and easements
- Restrictive covenants
- Rights of light
- Party wall matters

5. FINANCIAL CHARGES
- Existing mortgages and charges
- Financial liabilities affecting the property
- Redemption requirements

6. TITLE DEFECTS AND CONCERNS
- Any defects in title identified
- Missing documents or information
- Potential issues requiring resolution

7. RECOMMENDATIONS
- Actions required before completion
- Additional searches recommended
- Insurance recommendations
- Risk mitigation advice

8. CONCLUSION
- Overall assessment of the title
- Suitability for mortgage purposes
- Any reservations or qualifications

Please write this as a professional legal document that would be suitable for presentation to a client and their lender. Use formal legal language appropriate for conveyancing practice. Highlight any serious issues or concerns that could affect the transaction.

The report should be comprehensive but focused specifically on title matters - this is not a general due diligence report but specifically a Report on Title examining the legal ownership and rights affecting the property.

IMPORTANT: Please format your response as well-structured Markdown with proper headings, bullet points, tables where appropriate, and clear formatting. Use # for main sections, ## for subsections, and proper markdown syntax throughout.
`;
}


module.exports = {
  generateDiligenceReport,
};
