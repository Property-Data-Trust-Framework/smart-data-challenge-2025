const { onRequest } = require("firebase-functions/v2/https");
const { config } = require("firebase-functions");
const { OpenAI } = require("openai");
const { zodResponseFormat } = require("openai/helpers/zod");
const { z } = require("zod");

/**
 * Generate AI-powered Report on Title
 * This function integrates with OpenAI to provide comprehensive title analysis
 */

// Zod schema for the Report on Title response
const ReportOnTitleSchema = z.object({
  property: z.object({
    address: z.string().describe("Property address"),
    titleNumber: z.string().describe("Title number"),
    date: z.string().describe("Report date"),
  }),
  titleSummary: z.object({
    description: z.string().describe("Brief description of the property and title"),
    registeredProprietor: z.string().describe("Registered proprietor details"),
    classOfTitle: z.string().describe("Class of title and tenure"),
  }),
  titleExamination: z.object({
    titleDocuments: z.string().describe("Review of title documents and entries"),
    restrictions: z.string().describe("Analysis of any restrictions on the register"),
    charges: z.string().describe("Examination of charges and incumbrances"),
    covenants: z.string().describe("Review of covenants affecting the property"),
  }),
  planningStatutory: z.object({
    planning: z.string().describe("Planning permissions and applications"),
    buildingRegulations: z.string().describe("Building regulations compliance"),
    conservation: z.string().describe("Conservation area or listed building status"),
    environmental: z.string().describe("Environmental and contamination issues"),
  }),
  thirdPartyRights: z.object({
    rightsOfWay: z.string().describe("Rights of way and easements"),
    restrictiveCovenants: z.string().describe("Restrictive covenants"),
    rightsOfLight: z.string().describe("Rights of light"),
    partyWall: z.string().describe("Party wall matters"),
  }),
  financialCharges: z.object({
    existingMortgages: z.string().describe("Existing mortgages and charges"),
    liabilities: z.string().describe("Financial liabilities affecting the property"),
    redemption: z.string().describe("Redemption requirements"),
  }),
  titleDefects: z.object({
    defects: z.string().describe("Any defects in title identified"),
    missingDocuments: z.string().describe("Missing documents or information"),
    issues: z.string().describe("Potential issues requiring resolution"),
  }),
  recommendations: z.object({
    actions: z.string().describe("Actions required before completion"),
    searches: z.string().describe("Additional searches recommended"),
    insurance: z.string().describe("Insurance recommendations"),
    riskMitigation: z.string().describe("Risk mitigation advice"),
  }),
  conclusion: z.object({
    assessment: z.string().describe("Overall assessment of the title"),
    mortgageSuitability: z.string().describe("Suitability for mortgage purposes"),
    reservations: z.string().describe("Any reservations or qualifications"),
  }),
});
const generateDiligenceReport = onRequest(
  {
    cors: true,
    invoker: "public", // Demo access - would be "private" in production
    timeoutSeconds: 300, // 5 minutes for AI processing
  },
  async (req, res) => {
    try {
      // Only allow POST requests
      if (req.method !== "POST") {
        return res.status(405).json({ error: "Method not allowed" });
      }

      const { stateData, claimsData, analysisType = "report-on-title" } = req.body;

      if (!stateData) {
        return res.status(400).json({ error: "State data is required" });
      }

      // Generate AI-powered Report on Title
      const reportOnTitle = await generateReportOnTitle(stateData, claimsData);

      const report = {
        analysisType,
        timestamp: new Date().toISOString(),
        transactionId: stateData.transactionId || "unknown",
        property: {
          address: stateData.propertyPack?.address || "Address not specified",
          titleNumber: stateData.propertyPack?.titleNumber || "Title number not available",
        },

        // AI Generated Report on Title
        reportOnTitle: reportOnTitle || "AI Report on Title unavailable - please check OpenAI configuration",

        // Disclaimer
        disclaimer: "This Report on Title is generated by AI for demonstration purposes. This analysis should not be relied upon for actual conveyancing transactions. Professional legal advice should always be sought.",
      };

      res.json({
        success: true,
        report,
      });
    } catch (error) {
      console.error("Error generating Report on Title:", error);
      res.status(500).json({
        error: "Failed to generate Report on Title",
        details: error.message,
      });
    }
  },
);

// OpenAI Integration for Report on Title
async function generateReportOnTitle(stateData, claimsData) {
  try {
    // Get OpenAI API key from environment variables (local) or Firebase config (production)
    const openaiApiKey = process.env.OPENAI_API_KEY || config().openai?.api_key;

    if (!openaiApiKey) {
      console.log("OpenAI API key not found, skipping AI Report on Title generation");
      return null;
    }

    const openai = new OpenAI({
      apiKey: openaiApiKey,
    });

    // Create comprehensive prompt for Report on Title
    const prompt = createReportOnTitlePrompt(stateData, claimsData);

    // Use OpenAI's zodResponseFormat helper for structured output
    const responseFormat = zodResponseFormat(ReportOnTitleSchema, "ReportOnTitle");

    // Set appropriate parameters for GPT-5
    const requestConfig = {
      model: "gpt-5-mini", // Use GPT-5 Mini for Report on Title generation
      messages: [
        {
          role: "system",
          content: "You are an experienced conveyancing solicitor preparing a comprehensive Report on Title. Your response should be a detailed, professional report examining the title to the property, identifying any issues, risks, or concerns that could affect the transaction. Provide thorough analysis in each section with specific details relevant to the property data provided.",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      response_format: responseFormat,
    };

    // GPT-5 models only support temperature = 1
    if (requestConfig.model.startsWith("gpt-5")) {
      requestConfig.temperature = 1;
      requestConfig.max_completion_tokens = 8000; // Use max_completion_tokens for GPT-5
      console.log("[AI Request] Using GPT-5 Mini with temperature=1 for Report on Title");
    } else {
      requestConfig.temperature = 0.3; // Lower temperature for consistent analysis
      requestConfig.max_tokens = 8000;
    }

    const response = await openai.chat.completions.create(requestConfig);

    // Parse the structured response - zodResponseFormat ensures valid structure
    let aiResult;
    try {
      const aiContent = response.choices[0]?.message?.content;
      if (!aiContent) return null;

      aiResult = JSON.parse(aiContent);

      // Additional validation with Zod to be extra safe
      const validationResult = ReportOnTitleSchema.safeParse(aiResult);
      if (!validationResult.success) {
        console.warn("Invalid AI response for Report on Title:", validationResult.error);
        return aiContent; // Fallback to raw content if validation fails
      }

      return validationResult.data;
    } catch (parseError) {
      console.error("Failed to parse Report on Title AI response:", parseError);
      // Fallback to raw content if parsing fails
      const aiContent = response.choices[0]?.message?.content;
      return aiContent || null;
    }
  } catch (error) {
    console.error("Error generating Report on Title:", error);
    return null;
  }
}

function createReportOnTitlePrompt(stateData, claimsData) {
  return `
REPORT ON TITLE REQUEST

Prepare a comprehensive Report on Title analyzing all available property data from the PDTF (Property Data Trust Framework).

COMPLETE PROPERTY TRANSACTION STATE:
${JSON.stringify(stateData, null, 2)}

${claimsData ? `\nINDIVIDUAL CLAIMS DATA WITH PROVENANCE:\n${JSON.stringify(claimsData, null, 2)}` : ""}

COMPREHENSIVE ANALYSIS REQUIRED - Review ALL available data including:

**TITLE & OWNERSHIP:**
- Registered proprietors and ownership structure
- Title number, class, and tenure details
- Title documents and register entries
- Any restrictions, notices, or entries on the register

**CHARGES & ENCUMBRANCES:**
- Outstanding mortgages requiring redemption (check propertyPack/titlesToBeSold/charges)
- Financial charges and their priority
- Matrimonial rights or other statutory charges
- Lender details and redemption requirements

**RESTRICTIONS & COVENANTS:**
- Restrictive covenants affecting property use
- Building restrictions or development limitations
- Consent requirements for alterations
- Rights of way, easements, and access rights

**PROPERTY CONDITION & ALTERATIONS:**
- Structural alterations and extensions (check alterationsAndChanges)
- Planning permissions and building regulations compliance
- Electrical works certification (electricalWorks)
- Window replacements and other modifications
- Works completion status

**ENVIRONMENTAL & STATUTORY:**
- Flood risk assessment (environmentalIssues/flooding)
- Coal/non-coal mining risks
- Radon levels and remediation
- Coastal erosion concerns
- Local authority planning issues

**SERVICES & UTILITIES:**
- Electricity, gas, water, and drainage connections
- Broadband and telecommunications infrastructure
- Solar panels, heat pumps, or renewable energy
- Green Deal loans or energy efficiency schemes

**LEGAL & COMPLIANCE:**
- Disputes, complaints, or boundary issues (check disputesAndComplaints)
- Party wall matters
- Planning breaches or enforcement notices
- Outstanding statutory notices
- Building regulation certificates

**TRANSACTION READINESS:**
- Seller's completion requirements (completionAndMoving)
- Property chain position
- Mortgage redemption sufficiency
- Missing documentation or certificates
- Items requiring resolution before exchange

**PARTICIPANTS & CHAIN:**
- All transaction participants and their roles
- Conveyancers, estate agents, and other professionals
- Chain implications

Provide SPECIFIC findings from the actual data - reference exact values, dates, amounts, and parties. Don't make generic statements. If data exists (e.g., flood risk = "Low", council tax band = "C"), include it. If critical information is missing, explicitly state what's needed.

Structure your analysis to give the buyer's solicitor complete visibility of all material facts affecting the transaction.
`;
}


module.exports = {
  generateDiligenceReport,
};
